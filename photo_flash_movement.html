<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Ghost House — Single Final Ball Only</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <style>
      body { margin: 0; font-family: sans-serif; }
      #hint { position: fixed; left:12px; top:12px; z-index:9999;
             background: rgba(0,0,0,0.6); color:#fff; padding:8px 10px; border-radius:6px; }
      #debug { position: fixed; left:12px; bottom:12px; z-index:9999;
              background: rgba(255,255,255,0.9); color:#000; padding:6px 8px; border-radius:6px; font-size:12px; }
    </style>
  </head>

  <body>
    <div id="hint">Click once, then look at deer & rabbit to flash them. After both photos there will be one final attack ball.</div>
    <div id="debug">debug: starting</div>

    <a-scene fog="type: linear; color: #111; near: 0.5; far: 40">
      <a-assets>
        <audio id="shutterAudio" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_bf1f2f0642.mp3?filename=camera-click-1422.mp3"></audio>
        <audio id="explosionAudio" src="https://cdn.pixabay.com/download/audio/2021/08/08/audio_4be8b2b26f.mp3?filename=explosion-04.mp3"></audio>
        <audio id="screamAudio" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_2f4e3b3f93.mp3?filename=sharp-scream-3.mp3"></audio>
      </a-assets>

      <a-sky color="#060606"></a-sky>
      <a-plane rotation="-90 0 0" width="60" height="60" color="#222" position="0 0 0"></a-plane>

      <!-- camera rig + cursor + flash plane -->
      <a-entity id="cameraRig">
        <a-entity id="camera" camera look-controls position="0 1.6 0">
          <a-entity id="cursor"
                    cursor="fuse: true; fuseTimeout: 800"
                    raycaster="objects: .photographable, .finalBall"
                    geometry="primitive: ring; radiusInner:0.012; radiusOuter:0.02"
                    material="color: #fff; shader: flat"
                    position="0 0 -1">
          </a-entity>

          <a-plane id="camFlash" color="white" width="4" height="3" position="0 0 -0.8" visible="false" material="shader: flat; side:double"></a-plane>
        </a-entity>
      </a-entity>

      <!-- photographable proxies -->
      <a-box id="deer" class="photographable" position="-1 0.8 -2.5" depth="0.6" height="0.9" width="1.2" color="#8B5A2B"></a-box>
      <a-sphere id="rabbit" class="photographable" position="1.4 0.5 -2" radius="0.3" color="#DDDDDD"></a-sphere>

      <!-- container for balls (we will NOT spawn any normal balls) -->
      <a-entity id="balls"></a-entity>

      <!-- final attack ball parent: final ball will be added here -->
      <a-entity id="finalBallParent"></a-entity>

      <!-- sound entities -->
      <a-entity id="shutterSound" sound="src: #shutterAudio; volume: 1"></a-entity>
      <a-entity id="explosionSound" sound="src: #explosionAudio; volume: 0.9"></a-entity>
      <a-entity id="screamSound" sound="src: #screamAudio; volume: 1"></a-entity>
    </a-scene>

    <script>
      const debugEl = document.getElementById('debug');
      function debug(msg){ console.log('[DBG]', msg); debugEl.textContent = 'debug: ' + msg; }

      // state flags
      let deerCaptured = false;
      let rabbitCaptured = false;
      let finalBallSpawned = false;

      // references
      const scene = document.querySelector('a-scene');
      const camFlash = document.getElementById('camFlash');
      const finalParent = document.getElementById('finalBallParent');
      const shutterEntity = document.getElementById('shutterSound');
      const explosionEntity = document.getElementById('explosionSound');
      const screamEntity = document.getElementById('screamSound');

      // unlock audio
      document.body.addEventListener('click', function unlockAudio() {
        const a = new Audio(document.querySelector('#shutterAudio').getAttribute('src'));
        a.play().then(()=> a.pause()).catch(()=>{});
        document.body.removeEventListener('click', unlockAudio);
        debug('audio unlocked');
      }, { once: true });

      // helpers
      function shortFlash(duration = 120) {
        camFlash.setAttribute('visible', 'true');
        setTimeout(()=> camFlash.setAttribute('visible', 'false'), duration);
      }
      function playShutter() {
        if (shutterEntity && shutterEntity.components && shutterEntity.components.sound) {
          shutterEntity.components.sound.playSound();
        }
      }

      // attach photo listeners
      scene.addEventListener('loaded', ()=> {
        debug('scene loaded — listeners attached');
        attachPhotoListeners();
        // DO NOT start any random ball spawner here; we want only the final ball after photos
      });

      function attachPhotoListeners(){
        const deer = document.getElementById('deer');
        const rabbit = document.getElementById('rabbit');

        [deer, rabbit].forEach(el=>{
          el.addEventListener('click', ()=> {
            if (el.dataset.captured) return;
            el.dataset.captured = 'true';
            playShutter();
            shortFlash(140);
            debug('captured ' + el.id);
            el.setAttribute('visible','false');
            if (el.id === 'deer') deerCaptured = true;
            if (el.id === 'rabbit') rabbitCaptured = true;

            // when both captured, spawn exactly one final ball
            if (deerCaptured && rabbitCaptured && !finalBallSpawned) {
              finalBallSpawned = true;
              debug('both photos taken — spawn final ball in 700ms');
              setTimeout(spawnSingleFinalBall, 700);
            }
          });

          el.addEventListener('mouseenter', ()=> debug('cursor entered ' + el.id));
          el.addEventListener('mouseleave', ()=> debug('cursor left ' + el.id));
        });
      }

      // spawn exactly one final attack ball and make it approach camera
      function spawnSingleFinalBall() {
        // clear any leftover "normal" balls just in case (should be none)
        const existing = Array.from(document.querySelectorAll('.ball'));
        existing.forEach(b => { if (b.parentNode) b.parentNode.removeChild(b); });

        const x = (Math.random() - 0.5) * 1.8;   // small lateral variance
        const y = 1.0;
        const zStart = -28;
        const finalBall = document.createElement('a-sphere');
        finalBall.setAttribute('class', 'finalBall clickable');
        finalBall.setAttribute('radius', 0.9);
        finalBall.setAttribute('position', `${x} ${y} ${zStart}`);
        finalBall.setAttribute('color', '#550000');
        finalBall.setAttribute('material', 'metalness:0.2; roughness:0.6');
        finalParent.appendChild(finalBall);

        // optional: allow player to gaze-destroy final ball before it reaches (remove this block if you want it unavoidable)
        finalBall.addEventListener('click', ()=> {
          // explosion + remove
          if (explosionEntity && explosionEntity.components && explosionEntity.components.sound) {
            explosionEntity.components.sound.playSound();
          } else {
            const src = document.querySelector('#explosionAudio').getAttribute('src');
            new Audio(src).play().catch(()=>{});
          }
          finalBall.setAttribute('animation__pop', 'property: scale; to: 1.8 1.8 1.8; dur: 160; easing: easeOutQuad');
          setTimeout(()=> { if (finalBall.parentNode) finalBall.parentNode.removeChild(finalBall); }, 220);
          debug('final ball destroyed by player');
        });

        // approach loop
        const approachSpeed = 10.0; // units/sec (tune to taste)
        let last = performance.now();
        function approach(now) {
          const dt = (now - last) / 1000;
          last = now;
          const pos = finalBall.getAttribute('position');
          pos.z += approachSpeed * dt;
          finalBall.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);

          if (pos.z > -1.0) {
            // final impact: scream + big flash
            if (screamEntity && screamEntity.components && screamEntity.components.sound) {
              screamEntity.components.sound.playSound();
            } else {
              const src = document.querySelector('#screamAudio').getAttribute('src');
              new Audio(src).play().catch(()=>{});
            }
            camFlash.setAttribute('visible', 'true');
            setTimeout(()=> camFlash.setAttribute('visible','false'), 700);

            // remove the final ball after short delay
            setTimeout(()=> { if (finalBall.parentNode) finalBall.parentNode.removeChild(finalBall); }, 200);

            debug('final ball reached player — scream played');
            return;
          }
          requestAnimationFrame(approach);
        }
        requestAnimationFrame(approach);
        debug('final ball spawned and approaching');
      }

      debug('script ready');
    </script>
  </body>
</html>
